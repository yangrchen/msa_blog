<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Yang Chen">
<meta name="dcterms.date" content="2023-10-30">

<title>Yang MSA - Censoring, Survival, and Hazards</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../../">
<link href="../../../../favicon.ico" rel="icon">
<script src="../../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../../index.html">
    <span class="navbar-title">Yang MSA</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../../notes/index.html"> 
<span class="menu-text">Notes</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../blog/index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/yangrchen"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Censoring, Survival, and Hazards</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">analytics</div>
                <div class="quarto-category">survival analysis</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Yang Chen </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">October 30, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#setup" id="toc-setup" class="nav-link active" data-scroll-target="#setup">Setup</a></li>
  <li><a href="#what-is-survival-analysis" id="toc-what-is-survival-analysis" class="nav-link" data-scroll-target="#what-is-survival-analysis"><span class="header-section-number">1</span> What is Survival Analysis?</a>
  <ul class="collapse">
  <li><a href="#numeric-target" id="toc-numeric-target" class="nav-link" data-scroll-target="#numeric-target"><span class="header-section-number">1.1</span> Numeric Target</a></li>
  <li><a href="#data-structure" id="toc-data-structure" class="nav-link" data-scroll-target="#data-structure"><span class="header-section-number">1.2</span> Data Structure</a></li>
  </ul></li>
  <li><a href="#time-and-censoring" id="toc-time-and-censoring" class="nav-link" data-scroll-target="#time-and-censoring"><span class="header-section-number">2</span> Time and Censoring</a>
  <ul class="collapse">
  <li><a href="#types-of-censoring" id="toc-types-of-censoring" class="nav-link" data-scroll-target="#types-of-censoring"><span class="header-section-number">2.1</span> Types of Censoring</a>
  <ul class="collapse">
  <li><a href="#right-left-and-interval-censoring" id="toc-right-left-and-interval-censoring" class="nav-link" data-scroll-target="#right-left-and-interval-censoring"><span class="header-section-number">2.1.1</span> Right, Left, and Interval Censoring</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#survival-function" id="toc-survival-function" class="nav-link" data-scroll-target="#survival-function"><span class="header-section-number">3</span> Survival Function</a>
  <ul class="collapse">
  <li><a href="#kaplan-meier-estimator" id="toc-kaplan-meier-estimator" class="nav-link" data-scroll-target="#kaplan-meier-estimator"><span class="header-section-number">3.1</span> Kaplan-Meier Estimator</a></li>
  <li><a href="#summary-statistics" id="toc-summary-statistics" class="nav-link" data-scroll-target="#summary-statistics"><span class="header-section-number">3.2</span> Summary Statistics</a></li>
  </ul></li>
  <li><a href="#stratified-analysis" id="toc-stratified-analysis" class="nav-link" data-scroll-target="#stratified-analysis"><span class="header-section-number">4</span> Stratified Analysis</a>
  <ul class="collapse">
  <li><a href="#log-rank-test" id="toc-log-rank-test" class="nav-link" data-scroll-target="#log-rank-test"><span class="header-section-number">4.1</span> Log-rank test</a></li>
  <li><a href="#wilcoxon-test" id="toc-wilcoxon-test" class="nav-link" data-scroll-target="#wilcoxon-test"><span class="header-section-number">4.2</span> Wilcoxon Test</a></li>
  </ul></li>
  <li><a href="#hazard-function" id="toc-hazard-function" class="nav-link" data-scroll-target="#hazard-function"><span class="header-section-number">5</span> Hazard Function</a>
  <ul class="collapse">
  <li><a href="#hazard-probabilities" id="toc-hazard-probabilities" class="nav-link" data-scroll-target="#hazard-probabilities"><span class="header-section-number">5.1</span> Hazard Probabilities</a></li>
  <li><a href="#hazard-rates" id="toc-hazard-rates" class="nav-link" data-scroll-target="#hazard-rates"><span class="header-section-number">5.2</span> Hazard Rates</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="setup" class="level1 unnumbered">
<h1 class="unnumbered">Setup</h1>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">Python</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(foreign)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'dplyr'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:stats':

    filter, lag</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    intersect, setdiff, setequal, union</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reticulate)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survminer)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: ggpubr</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'survminer'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:survival':

    myeloma</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">use_condaenv</span>(<span class="st">"msa"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sksurv.nonparametric <span class="im">import</span> kaplan_meier_estimator</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lifelines <span class="im">import</span> KaplanMeierFitter</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lifelines <span class="im">import</span> NelsonAalenFitter</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="what-is-survival-analysis" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> What is Survival Analysis?</h1>
<p>Survival analysis is a branch of statistics that deals with the analysis of time-to-event data. The event can be anything that occurs at a specific point in time, such as death, injury, or failure.</p>
<p><strong>Time</strong> generally refers to <strong>tenure</strong> rather than actual calendar time. The <strong>event</strong> is some specific outcome of interest:</p>
<ul>
<li>Customer cancel service</li>
<li>Customer makes another purchase</li>
<li>Patient develops disease</li>
</ul>
<p>Compare this to logistic regression, where we are studying if the event happened or not. Survival analysis is studying how long it took for the event to happen.</p>
<section id="numeric-target" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="numeric-target"><span class="header-section-number">1.1</span> Numeric Target</h2>
<p>We can’t use OLS for time-to-event data due to <strong>censoring</strong>. For some observations, the event may never occur or has not happened yet. Tenure is also always positive and the risk of failure can change over time–not a linear relationship.</p>
</section>
<section id="data-structure" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="data-structure"><span class="header-section-number">1.2</span> Data Structure</h2>
<p>Survival analysis splits the target variable into two pieces: a continuous and a categorical variable.</p>
<ul>
<li><strong>Time</strong>: Tenure for an observation</li>
<li><strong>Event</strong>: At the end of that time, what happened?</li>
</ul>
<p>Using the Maryland Recidivism Data, we want to model the association between various factors and length of time before re-arrest.</p>
<ul>
<li><strong>Week</strong>: Week of arrest - week which equals 52 is not arrested</li>
<li><strong>Arrest</strong>: Indicator for arrest (1 = yes, 0 = no)</li>
</ul>
<p>Predictors:</p>
<ul>
<li><strong>fin</strong>: Received financial aid upon release (1 = yes, 0 = no)</li>
<li><strong>age</strong>: Age at time of release (years)</li>
<li><strong>race</strong>: Indicator for African American (1 = yes, 0 = no)</li>
<li><strong>wexp</strong>: Indicator of prior work experience prior to incarceration (1 = yes, 0 = no)</li>
<li><strong>mar</strong>: Married at time of release (1 = yes, 0 = no)</li>
<li><strong>paro</strong>: Released on parole (1 = yes, 0 = no)</li>
<li><strong>prio</strong>: Number of prior convictions</li>
</ul>
</section>
</section>
<section id="time-and-censoring" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Time and Censoring</h1>
<p>Survival analysis depends on a few assumptions:</p>
<ul>
<li>Every observation starts at the same time since we are not interested in time, but tenure</li>
<li>We are interested in time to event <span class="math inline">\(T\)</span>, but we can not observe this for all observations–they are censored
<ul>
<li>We take the minimum between <span class="math inline">\(T_i\)</span> and the censoring time <span class="math inline">\(C_i\)</span></li>
</ul></li>
</ul>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-time-vs-tenure" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-time-vs-tenure-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/time-vs-tenure.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-time-vs-tenure-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Time vs.&nbsp;Tenure
</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-data-structure" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-data-structure-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/data-structure.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-data-structure-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Data Structure
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<p>Censored data is <strong>NOT</strong> missing data. We do not know the actual time to event <span class="math inline">\(T_i\)</span> for censored observations. We only know that for some amount of time the event has not occurred. Data is incomplete, but not missing.</p>
<section id="types-of-censoring" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="types-of-censoring"><span class="header-section-number">2.1</span> Types of Censoring</h2>
<p><strong>Type I</strong> censoring is where there is an end time <span class="math inline">\(c\)</span> and any subject that hasn’t had the event by time <strong>c</strong> is censored.</p>
<p><strong>Type II</strong> censoring is where time goes until a certain number of events have occurred and any subjects who haven’t had the event by that time are censored.</p>
<section id="right-left-and-interval-censoring" class="level3" data-number="2.1.1">
<h3 data-number="2.1.1" class="anchored" data-anchor-id="right-left-and-interval-censoring"><span class="header-section-number">2.1.1</span> Right, Left, and Interval Censoring</h3>
<p>Observation is <strong>right censored</strong> when <span class="math inline">\(T &gt; c\)</span>. An example is when a clinical trial ends and patient is still alive. Censoring is noninformative–patients who are censored should have the same future risk for the event happening, conditional on exposure, as those who continue to be followed.</p>
<p>Observation is <strong>left censored</strong> when <span class="math inline">\(T &lt; c\)</span>. An example is whne a customer enrolled more than 3 years ago. A new customer tracking system was implemented, but current customers were around before.</p>
<p><strong>Interval censoring</strong> is where <span class="math inline">\(a &lt; T &lt; b\)</span>. An example is when a person tests negative during appointment at <span class="math inline">\(a\)</span>, but positive during appointment at <span class="math inline">\(b\)</span>. So time developing disease occurs between <span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span>.</p>
</section>
</section>
</section>
<section id="survival-function" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Survival Function</h1>
<p>Survival analysis is described in two major quantities: <strong>survival function</strong> and <strong>hazard function</strong>.</p>
<p>Survival function: Probability of surviving <strong>beyond</strong> time <span class="math inline">\(t\)</span>.</p>
<p><span class="math display">\[
S(t) = P(T &gt; t)
\]</span></p>
<ul>
<li>Always starts at 1</li>
<li>Never increases</li>
<li>Bounded below by 0</li>
</ul>
<section id="kaplan-meier-estimator" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="kaplan-meier-estimator"><span class="header-section-number">3.1</span> Kaplan-Meier Estimator</h2>
<p>The Kaplan-Meier estimator is a non-parametric estimator of the survival function. It is a product of the survival probabilities at each time point. We want to estimate the proportion of individuals “still alive” at any given time <span class="math inline">\(t\)</span>.</p>
<p><span class="math display">\[
\hat{S}(t) = \prod_{k \leq t} \left(1 - \frac{d_k}{r_k}\right)
\]</span></p>
<ul>
<li><span class="math inline">\(d_k\)</span> is the number of events occurring at time <span class="math inline">\(t\)</span></li>
<li><span class="math inline">\(r_k\)</span> is the number of observations available right before time <span class="math inline">\(t\)</span> (<strong>risk set</strong>)</li>
</ul>
<p>Note that censored individuals are initially included in the risk set up until the point of censoring.</p>
<div id="fig-km-estimate" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-km-estimate-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/km-estimate.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-km-estimate-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Calculating K-M Estimate
</figcaption>
</figure>
</div>
</section>
<section id="summary-statistics" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="summary-statistics"><span class="header-section-number">3.2</span> Summary Statistics</h2>
<p>Due to censoring, mean is difficult to estimate but the <strong>median</strong> is still valid as long as the event occurs for at least half of the sample.</p>
<p>The median is the <strong>half-life</strong> or the time <span class="math inline">\(t\)</span> that <span class="math inline">\(\hat{S}(t)\)</span> drops below 0.5. The half-life interpretation is that 50% of observations survive beyond time <span class="math inline">\(t\)</span>.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false">Python</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>recid <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://raw.githubusercontent.com/sjsimmo2/Survival/master/recid.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 432 Columns: 63
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
dbl (63): week, arrest, fin, age, race, wexp, mar, paro, prio, educ, emp1, e...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>simple <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">10</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>), <span class="at">ncol =</span> <span class="dv">2</span>))</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(simple) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"tenure"</span>, <span class="st">"censored"</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>simple_s <span class="ot">&lt;-</span> <span class="fu">Surv</span>(<span class="at">time =</span> simple<span class="sc">$</span>tenure, <span class="at">event =</span> simple<span class="sc">$</span>censored)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>To perform Kaplan-Meier:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>simple_km <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(<span class="at">time =</span> tenure, <span class="at">event =</span> censored) <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> simple)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(simple_km)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = Surv(time = tenure, event = censored) ~ 1, 
    data = simple)

 time n.risk n.event survival std.err lower 95% CI upper 95% CI
    2      6       1    0.833   0.152       0.5827            1
    3      5       1    0.667   0.192       0.3786            1
    7      3       1    0.444   0.222       0.1668            1
    8      2       1    0.222   0.192       0.0407            1</code></pre>
</div>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(simple_km, <span class="at">main =</span> <span class="st">"Survival Function"</span>, <span class="at">xlab =</span> <span class="st">"Tenure"</span>, <span class="at">ylab =</span> <span class="st">"Survival Probability"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>recid_fit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(<span class="at">time =</span> week, <span class="at">event =</span> arrest) <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> recid)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(recid_fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = Surv(time = week, event = arrest) ~ 1, data = recid)

 time n.risk n.event survival std.err lower 95% CI upper 95% CI
    1    432       1    0.998 0.00231        0.993        1.000
    2    431       1    0.995 0.00327        0.989        1.000
    3    430       1    0.993 0.00400        0.985        1.000
    4    429       1    0.991 0.00461        0.982        1.000
    5    428       1    0.988 0.00515        0.978        0.999
    6    427       1    0.986 0.00563        0.975        0.997
    7    426       1    0.984 0.00607        0.972        0.996
    8    425       5    0.972 0.00791        0.957        0.988
    9    420       2    0.968 0.00852        0.951        0.984
   10    418       1    0.965 0.00881        0.948        0.983
   11    417       2    0.961 0.00935        0.942        0.979
   12    415       2    0.956 0.00987        0.937        0.976
   13    413       1    0.954 0.01011        0.934        0.974
   14    412       3    0.947 0.01080        0.926        0.968
   15    409       2    0.942 0.01123        0.920        0.964
   16    407       2    0.937 0.01165        0.915        0.961
   17    405       3    0.931 0.01223        0.907        0.955
   18    402       3    0.924 0.01278        0.899        0.949
   19    399       2    0.919 0.01313        0.894        0.945
   20    397       5    0.907 0.01395        0.880        0.935
   21    392       2    0.903 0.01425        0.875        0.931
   22    390       1    0.900 0.01440        0.873        0.929
   23    389       1    0.898 0.01455        0.870        0.927
   24    388       4    0.889 0.01512        0.860        0.919
   25    384       3    0.882 0.01552        0.852        0.913
   26    381       3    0.875 0.01591        0.844        0.907
   27    378       2    0.870 0.01616        0.839        0.903
   28    376       2    0.866 0.01640        0.834        0.898
   30    374       2    0.861 0.01664        0.829        0.894
   31    372       1    0.859 0.01675        0.827        0.892
   32    371       2    0.854 0.01698        0.822        0.888
   33    369       2    0.850 0.01720        0.816        0.884
   34    367       2    0.845 0.01742        0.811        0.880
   35    365       4    0.836 0.01783        0.801        0.871
   36    361       3    0.829 0.01813        0.794        0.865
   37    358       4    0.819 0.01851        0.784        0.857
   38    354       1    0.817 0.01860        0.781        0.854
   39    353       2    0.812 0.01878        0.777        0.850
   40    351       4    0.803 0.01913        0.767        0.842
   42    347       2    0.799 0.01929        0.762        0.837
   43    345       4    0.789 0.01962        0.752        0.829
   44    341       2    0.785 0.01977        0.747        0.824
   45    339       2    0.780 0.01993        0.742        0.820
   46    337       4    0.771 0.02022        0.732        0.812
   47    333       1    0.769 0.02029        0.730        0.809
   48    332       2    0.764 0.02043        0.725        0.805
   49    330       5    0.752 0.02077        0.713        0.794
   50    325       3    0.745 0.02096        0.705        0.788
   52    322       4    0.736 0.02121        0.696        0.779</code></pre>
</div>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsurvplot</span>(recid_fit, <span class="at">data =</span> recid, <span class="at">conf.int =</span> <span class="cn">TRUE</span>, <span class="at">palette =</span> <span class="st">"purple"</span>, <span class="at">xlab =</span> <span class="st">"Week"</span>, <span class="at">ylab =</span> <span class="st">"Survival Probability"</span>, <span class="at">legend =</span> <span class="st">"none"</span>, <span class="at">break.y.by =</span> <span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">

</div>
</div>
</div>
</section>
</section>
<section id="stratified-analysis" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Stratified Analysis</h1>
<p>We can also create separate / stratified curves by group. Different curves result in different estimates for each group.</p>
<p>R provides 2 tests that each have the same null hypothesis–all survival curves are <strong>equal</strong> and alternative is that at least one curve is different.</p>
<ol type="1">
<li>Log-rank Test</li>
<li>Wilcoxon Test</li>
</ol>
<section id="log-rank-test" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="log-rank-test"><span class="header-section-number">4.1</span> Log-rank test</h2>
<p>Combines all the information from the K-M estimate at times where events occur.</p>
<p>For each group, calculate expected events and compare to observed events. This is a <span class="math inline">\(\chi^2\)</span> statistic with <span class="math inline">\(k - 1\)</span> degrees of freedom.</p>
<div id="fig-log-rank" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-log-rank-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/log-rank.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-log-rank-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Log-rank Tests
</figcaption>
</figure>
</div>
</section>
<section id="wilcoxon-test" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="wilcoxon-test"><span class="header-section-number">4.2</span> Wilcoxon Test</h2>
<p>Similar to Log-rank test except that we now use weights. This test places larger emphasis on earlier event times.</p>
</section>
</section>
<section id="hazard-function" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Hazard Function</h1>
<p>The <strong>hazard function</strong> is the instantaneous rate of failure at time <span class="math inline">\(t\)</span> given that the individual has survived up to time <span class="math inline">\(t\)</span>.</p>
<p>We have two common types of hazard functions: harzard probabilities and hazard rates.</p>
<section id="hazard-probabilities" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="hazard-probabilities"><span class="header-section-number">5.1</span> Hazard Probabilities</h2>
<p><span class="math display">\[
h(t) = P(t &lt; T &lt; t + 1 | T &gt; t)
\]</span></p>
<p>In general, hazard probability can be interpreted as “assuming the event has not occurred yet, this is the probability the events occurs by the next time point.”</p>
<p>An example is that a customer has survived for a certain length of time, so the customer’s tenure is <span class="math inline">\(t\)</span>. What is the probability that the customer leaves before <span class="math inline">\(t + 1\)</span>?</p>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-hazard-probability-events" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-hazard-probability-events-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/hazard-probability-events.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-hazard-probability-events-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Hazard Probability Events
</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-hazard-probability-calculations" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-hazard-probability-calculations-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/hazard-probability-calculations.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-hazard-probability-calculations-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: Hazard Probability Calculations
</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="hazard-rates" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="hazard-rates"><span class="header-section-number">5.2</span> Hazard Rates</h2>
<p><span class="math display">\[
h(t) = \lim_{\Delta t \to 0} \frac{P(t &lt; T &lt; t + \Delta t | T &gt; t)}{\Delta t}
\]</span></p>
<p>Hazard rates have a slightly different interpretation than hazard probabilities because they are limits. Hazard rates are the instantaneous event rate at time <span class="math inline">\(t\)</span> for the risk set at time <span class="math inline">\(t\)</span>.</p>
<p>The inverse of the hazard function is the length of time before the next occurrence.</p>
<p>The <strong>cumulative hazard probability</strong> is just the total hazard rate up until time <span class="math inline">\(t\)</span>–denoted by <span class="math inline">\(\Lambda(t)\)</span>.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>