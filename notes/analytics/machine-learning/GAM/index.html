<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Yang Chen">
<meta name="dcterms.date" content="2023-10-31">

<title>Yang MSA - Generalized Additive Models</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../../">
<link href="../../../../favicon.ico" rel="icon">
<script src="../../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../../../index.html">
    <span class="navbar-title">Yang MSA</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../../notes/index.html" rel="" target="">
 <span class="menu-text">Notes</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../blog/index.html" rel="" target="">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/yangrchen" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Generalized Additive Models</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">analytics</div>
                <div class="quarto-category">machine learning</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Yang Chen </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">October 31, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#general-structure" id="toc-general-structure" class="nav-link active" data-scroll-target="#general-structure"><span class="header-section-number">1</span> General Structure</a></li>
  <li><a href="#piecewise-linear-regression" id="toc-piecewise-linear-regression" class="nav-link" data-scroll-target="#piecewise-linear-regression"><span class="header-section-number">2</span> Piecewise Linear Regression</a>
  <ul class="collapse">
  <li><a href="#extensions---discontinuous" id="toc-extensions---discontinuous" class="nav-link" data-scroll-target="#extensions---discontinuous"><span class="header-section-number">2.1</span> Extensions - Discontinuous</a></li>
  </ul></li>
  <li><a href="#mars-multivariate-adaptive-regression-splines" id="toc-mars-multivariate-adaptive-regression-splines" class="nav-link" data-scroll-target="#mars-multivariate-adaptive-regression-splines"><span class="header-section-number">3</span> MARS (Multivariate Adaptive Regression Splines)</a>
  <ul class="collapse">
  <li><a href="#variable-importance" id="toc-variable-importance" class="nav-link" data-scroll-target="#variable-importance"><span class="header-section-number">3.1</span> Variable Importance</a></li>
  </ul></li>
  <li><a href="#smoothing" id="toc-smoothing" class="nav-link" data-scroll-target="#smoothing"><span class="header-section-number">4</span> Smoothing</a>
  <ul class="collapse">
  <li><a href="#loess" id="toc-loess" class="nav-link" data-scroll-target="#loess"><span class="header-section-number">4.1</span> LOESS</a></li>
  <li><a href="#smoothing-splines" id="toc-smoothing-splines" class="nav-link" data-scroll-target="#smoothing-splines"><span class="header-section-number">4.2</span> Smoothing Splines</a></li>
  <li><a href="#regression-splines" id="toc-regression-splines" class="nav-link" data-scroll-target="#regression-splines"><span class="header-section-number">4.3</span> Regression Splines</a></li>
  </ul></li>
  <li><a href="#implementing-smoothing" id="toc-implementing-smoothing" class="nav-link" data-scroll-target="#implementing-smoothing"><span class="header-section-number">5</span> Implementing Smoothing</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">6</span> Summary</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="general-structure" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> General Structure</h1>
<p>GAMs provide a general framework for adding non-linear functions together instead of the typical linear structure.</p>
<p><span class="math display">\[
y = \beta_0 + f_1(x_1) + f_2(x_2) + \cdots + f_p(x_p) + \epsilon
\]</span></p>
</section>
<section id="piecewise-linear-regression" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Piecewise Linear Regression</h1>
<p>What if you had a linear relationship between <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span>, but the slope changes? Different pieces might have a straight-line relationship, but a typical single straight-line model will not be a good fit for this type of data.</p>
<div id="fig-changing-slopes" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/changing-slopes.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;1: Changing Slopes</figcaption>
</figure>
</div>
<p>A model where different straight-line relationships for different intervals in the predictor variable is called the <strong>piecewise linear regression model</strong>. For two slopes, the model follows as:</p>
<p><span class="math display">\[
y = \beta_0 + \beta_1x_1 + \beta_2(x_1 - k)x_2 + \epsilon
\]</span></p>
<ul>
<li><span class="math inline">\(k\)</span> is the knot value for <span class="math inline">\(x_1\)</span></li>
</ul>
<p>How do we split up the pieces? <span class="math inline">\(x_2\)</span> depends on how the value of <span class="math inline">\(x_1\)</span> compares to the knot value:</p>
<p><span class="math display">\[
x_2 = \begin{cases}
    1 &amp; x_1 &gt; k \\
    0 &amp; x_1 \leq k
\end{cases}
\]</span></p>
<div id="fig-cement-example" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/cement-example.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;2: Cement Example</figcaption>
</figure>
</div>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>cement <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/cement.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 18 Columns: 5
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
dbl (5): BATCH, STRENGTH, RATIO, X2, X2STAR

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>cement_lm <span class="ot">&lt;-</span> <span class="fu">lm</span>(STRENGTH <span class="sc">~</span> RATIO <span class="sc">+</span> X2STAR, <span class="at">data =</span> cement)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(cement, <span class="fu">aes</span>(<span class="at">x =</span> RATIO, <span class="at">y =</span> STRENGTH)) <span class="sc">+</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">data =</span> cement, <span class="fu">aes</span>(<span class="at">x =</span> RATIO, <span class="at">y =</span> cement_lm<span class="sc">$</span>fitted.values)) <span class="sc">+</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<section id="extensions---discontinuous" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="extensions---discontinuous"><span class="header-section-number">2.1</span> Extensions - Discontinuous</h2>
<p>The previous approach had piecewise functions that are continuous. The following is the discontinuous version for two straight lines:</p>
<p><span class="math display">\[
y = \beta_0 + \beta_1x_1 + \beta_2(x_1 - k)x_2 + \beta_3x_2 + \epsilon
\]</span></p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>cement_lm <span class="ot">&lt;-</span> <span class="fu">lm</span>(STRENGTH <span class="sc">~</span> RATIO <span class="sc">+</span> X2STAR <span class="sc">+</span> X2, <span class="at">data =</span> cement)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cement_lm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = STRENGTH ~ RATIO + X2STAR + X2, data = cement)

Residuals:
     Min       1Q   Median       3Q      Max 
-0.53167 -0.15513  0.06171  0.17239  0.49451 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  7.04975    0.68558  10.283  6.6e-08 ***
RATIO       -0.05240    0.01174  -4.463 0.000536 ***
X2STAR      -0.07888    0.02686  -2.937 0.010830 *  
X2          -0.60388    0.26877  -2.247 0.041302 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.2916 on 14 degrees of freedom
Multiple R-squared:  0.9548,    Adjusted R-squared:  0.9451 
F-statistic: 98.57 on 3 and 14 DF,  p-value: 1.188e-09</code></pre>
</div>
</div>
<p>For <span class="math inline">\(k\)</span> straight lines, we can produce <span class="math inline">\(k - 1\)</span> knot values to model our data.</p>
<div id="fig-extension-knots" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/extension-knots.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;3: Extension - Knots</figcaption>
</figure>
</div>
</section>
</section>
<section id="mars-multivariate-adaptive-regression-splines" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> MARS (Multivariate Adaptive Regression Splines)</h1>
<p>MARS is a generalization of piecewise linear regression. It is a non-parametric regression method that uses a series of nonlinearities and interactions between variables in a additive form. Essentially, uses <strong>piecewise</strong> regression to split into pieces then potentially uses either linear or nonlinear patterns for each piece.</p>
<p>MARS looks for a point in the range of <span class="math inline">\(x\)</span> where two linear functions on either side of the point provides the least squared error.</p>
<div id="fig-many-knots" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/many-knots.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;4: Different Knot Values</figcaption>
</figure>
</div>
<p>Algorithm continnues on each piece of piecewise function until many knots are found–this will overfit your data. MARS uses a <strong>pruning</strong> algorithm to remove knots that do not improve the model. The way it does this is by comparing the model without the knot to the model with the knot and selects the model which does better on <strong>generalized cross-validation</strong>. This is repeated for each variable we provide to the model.</p>
<p>For open-source software, the implementation is <strong>EARTH</strong> (Enhanced Adaptive Regression Through Hinges).</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(earth)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: Formula</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: plotmo</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: plotrix</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: TeachingDemos</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>mars1 <span class="ot">&lt;-</span> <span class="fu">earth</span>(Sale_Price <span class="sc">~</span> Garage_Area, <span class="at">data =</span> training)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mars1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call: earth(formula=Sale_Price~Garage_Area, data=training)

                    coefficients
(Intercept)           124159.039
h(286-Garage_Area)       -60.257
h(Garage_Area-286)       297.277
h(Garage_Area-521)      -483.642
h(Garage_Area-576)       733.859
h(Garage_Area-758)      -356.460
h(Garage_Area-1043)     -490.873

Selected 7 of 7 terms, and 1 of 1 predictors
Termination condition: RSq changed by less than 0.001 at 7 terms
Importance: Garage_Area
Number of terms at each degree of interaction: 1 6 (additive model)
GCV 3427475346    RSS 6.94092e+12    GRSq 0.4492014    RSq 0.4556309</code></pre>
</div>
</div>
<p>Each value in the EARTH output represents a knot / hinge value. For example, h(Garage_Area - 286) is the knot value when Garage_Area is 286. A new line is created at this point.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(training, <span class="fu">aes</span>(<span class="at">x =</span> Garage_Area, <span class="at">y =</span> Sale_Price)) <span class="sc">+</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">data =</span> training, <span class="fu">aes</span>(<span class="at">x =</span> Garage_Area, <span class="at">y =</span> mars1<span class="sc">$</span>fitted.values), <span class="at">color =</span> <span class="st">"blue"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Creating a model on the full data:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>mars1 <span class="ot">&lt;-</span> <span class="fu">earth</span>(Sale_Price <span class="sc">~</span> ., <span class="at">data =</span> training)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mars1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call: earth(formula=Sale_Price~., data=training)

                      coefficients
(Intercept)              319493.46
Central_AirY              20289.49
h(4-Bedroom_AbvGr)         9214.66
h(Bedroom_AbvGr-4)       -23009.05
h(Year_Built-1977)         1275.57
h(2004-Year_Built)         -336.64
h(Year_Built-2004)         5315.57
h(13869-Lot_Area)            -2.09
h(Lot_Area-13869)             0.22
h(First_Flr_SF-1600)        104.91
h(2402-First_Flr_SF)        -71.56
h(First_Flr_SF-2402)       -176.61
h(1523-Second_Flr_SF)       -53.13
h(Second_Flr_SF-1523)       426.63
h(Half_Bath-1)           -45378.31
h(2-Fireplaces)          -14408.56
h(Fireplaces-2)          -26072.58
h(Garage_Area-539)          101.97
h(Garage_Area-1043)        -294.30
h(Gr_Liv_Area-2049)          65.21
h(Gr_Liv_Area-3194)        -159.79

Selected 21 of 24 terms, and 10 of 14 predictors
Termination condition: Reached nk 29
Importance: First_Flr_SF, Second_Flr_SF, Year_Built, Garage_Area, ...
Number of terms at each degree of interaction: 1 20 (additive model)
GCV 1033819964    RSS 2.036439e+12    GRSq 0.8338641    RSq 0.8402842</code></pre>
</div>
</div>
<p>Notice that our output shows how many predictors were used in the model. We also have a list of variable importance. What is going on in the variable importance?</p>
<section id="variable-importance" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="variable-importance"><span class="header-section-number">3.1</span> Variable Importance</h2>
<p>There is one “subset” for each model size (1 term, 2 terms, etc.)–the best model of that size. The variable importance is the number of times that variable was used in the best model of that size. The more subsets of models the variable appears in the better the variable.</p>
<p><strong>Residual sum of squares</strong> is a scaled version of decrease in residual sum of squares relative to the previous subset. GCV is an approximation of RSS on leave-one-out cross validation.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">evimp</span>(mars1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>              nsubsets   gcv    rss
First_Flr_SF        20 100.0  100.0
Second_Flr_SF       19  71.7   71.9
Year_Built          18  50.9   51.3
Garage_Area         17  34.3   35.0
Fireplaces          16  31.0   31.7
Gr_Liv_Area         15  27.6   28.4
Central_AirY        12  20.0   20.9
Bedroom_AbvGr       11  18.1   19.0
Lot_Area            10  16.2   17.2
Half_Bath            4   7.4    8.2</code></pre>
</div>
</div>
<p>Each variable following the first variable is the amount of improvement in the residual sum of squares relative to the amount of improvement in the first variable.</p>
<p>Be careful, we have no notion of how these variables affect the response just which variables we think are the most important in the model. We trade interpretability for predictive power.</p>
</section>
</section>
<section id="smoothing" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Smoothing</h1>
<p>Smoothing is a way to reduce the variance of our model. In GAMs, we can use <strong>smoothing functions</strong> to approximate a curve representing the signal of our data. One common example is <strong>LOESS (locally estimated scatterplot smoothing)</strong>.</p>
<section id="loess" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="loess"><span class="header-section-number">4.1</span> LOESS</h2>
<p>LOESS is a non-parametric regression method that estimates the latent signal in a point-wise fashion. Essnetially, for each point we calculate a local weighted regression of a fixed window size around the point and record the point’s prediction along the local regression. However, more weight is assigned to points closer to the point of interest while less weight is assigned to points further away.</p>
<p>Large window sizes result in higher bias (more points to consider) while lower values will increase variance (less points to consider). The window size is a hyperparameter that we can tune.</p>
<div id="fig-loess-visual" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/loess-visual.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;5: LOESS Visualized</figcaption>
</figure>
</div>
</section>
<section id="smoothing-splines" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="smoothing-splines"><span class="header-section-number">4.2</span> Smoothing Splines</h2>
<p><strong>Smoothing splines</strong> have a knot at <strong>every single observation</strong> for piecewise regression. We use a penalty parameter to counterbalance the overfitting.</p>
<p>Smoothing splines are optimizing the following equation:</p>
<p><span class="math display">\[
\min \sum_{i=1}^{n} (y_i - s(x_i))^2 + \lambda \int s''(t_i)^2 dt
\]</span></p>
<ul>
<li>The first sum is the residual sum of squares</li>
<li>The second term is the penalty applied to integral of second derivative of smoothing function</li>
<li>The penalty <span class="math inline">\(\lambda\)</span> is estimated with an approximation of leave one out cross validation</li>
</ul>
<p>The idea behind the second derivative in the penalty term is that it gives us an idea of how fast our slopes (first derivatives) are changing. The larger the second derivative, the faster the slope is changing. We want to penalize large changes in slope to lower the variance of our model.</p>
</section>
<section id="regression-splines" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="regression-splines"><span class="header-section-number">4.3</span> Regression Splines</h2>
<p>Essentially <strong>regression splines</strong> are a computationally nicer version of smoothing splines.</p>
</section>
</section>
<section id="implementing-smoothing" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Implementing Smoothing</h1>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">Python</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: nlme</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'nlme'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:dplyr':

    collapse</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>This is mgcv 1.9-0. For overview type 'help("mgcv-package")'.</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>gam1 <span class="ot">&lt;-</span> <span class="fu">gam</span>(Sale_Price <span class="sc">~</span> <span class="fu">s</span>(Garage_Area), <span class="at">data =</span> training)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(gam1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Family: gaussian 
Link function: identity 

Formula:
Sale_Price ~ s(Garage_Area)

Parametric coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)   180897       1290   140.2   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Approximate significance of smooth terms:
                 edf Ref.df     F p-value    
s(Garage_Area) 8.134  8.769 192.5  &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

R-sq.(adj) =  0.451   Deviance explained = 45.3%
GCV = 3.4301e+09  Scale est. = 3.4148e+09  n = 2051</code></pre>
</div>
</div>
<p>We see a section for coefficients not involved in splines and a section for smoothing terms. The p-value for the spline of <code>Garage_Area</code> shows the significance of the variable to the model <strong>as a whole.</strong> These p-values are essentially results from likelihood ratio tests. We can plot the relationship using the <code>plot</code> function:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(gam1, <span class="at">se =</span> <span class="cn">TRUE</span>, <span class="at">col =</span> <span class="st">"blue"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can also apply this to multiple variables:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>gam2 <span class="ot">&lt;-</span> <span class="fu">gam</span>(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    Sale_Price <span class="sc">~</span> <span class="fu">s</span>(Bedroom_AbvGr, <span class="at">k =</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">s</span>(Year_Built) <span class="sc">+</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">s</span>(Mo_Sold) <span class="sc">+</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">s</span>(Lot_Area) <span class="sc">+</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">s</span>(First_Flr_SF) <span class="sc">+</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">s</span>(Second_Flr_SF) <span class="sc">+</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">s</span>(Garage_Area) <span class="sc">+</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">s</span>(Gr_Liv_Area) <span class="sc">+</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">s</span>(TotRms_AbvGrd) <span class="sc">+</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>        Street <span class="sc">+</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>        Central_Air <span class="sc">+</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">factor</span>(Fireplaces) <span class="sc">+</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">factor</span>(Full_Bath) <span class="sc">+</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">factor</span>(Half_Bath),</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">"REML"</span>, <span class="at">data =</span> training</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(gam2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Family: gaussian 
Link function: identity 

Formula:
Sale_Price ~ s(Bedroom_AbvGr, k = 5) + s(Year_Built) + s(Mo_Sold) + 
    s(Lot_Area) + s(First_Flr_SF) + s(Second_Flr_SF) + s(Garage_Area) + 
    s(Gr_Liv_Area) + s(TotRms_AbvGrd) + Street + Central_Air + 
    factor(Fireplaces) + factor(Full_Bath) + factor(Half_Bath)

Parametric coefficients:
                    Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)           136139      19682   6.917 6.20e-12 ***
StreetPave             27690      12710   2.179   0.0295 *  
Central_AirY           18012       3168   5.685 1.50e-08 ***
factor(Fireplaces)1    14069       1666   8.443  &lt; 2e-16 ***
factor(Fireplaces)2    27137       3146   8.626  &lt; 2e-16 ***
factor(Fireplaces)3    15705      10552   1.488   0.1368    
factor(Fireplaces)4   -79591      31469  -2.529   0.0115 *  
factor(Full_Bath)1     -5341      14528  -0.368   0.7132    
factor(Full_Bath)2    -11074      14828  -0.747   0.4552    
factor(Full_Bath)3      1225      15787   0.078   0.9382    
factor(Full_Bath)4    -16268      24327  -0.669   0.5038    
factor(Half_Bath)1      2102       2206   0.953   0.3408    
factor(Half_Bath)2    -38508       9111  -4.226 2.48e-05 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Approximate significance of smooth terms:
                   edf Ref.df       F p-value    
s(Bedroom_AbvGr) 2.653  3.166  18.787  &lt;2e-16 ***
s(Year_Built)    6.445  7.543 101.759  &lt;2e-16 ***
s(Mo_Sold)       1.521  1.875   0.990  0.4500    
s(Lot_Area)      7.186  8.193  11.726  &lt;2e-16 ***
s(First_Flr_SF)  8.063  8.765  15.548  &lt;2e-16 ***
s(Second_Flr_SF) 8.212  8.818   7.806  &lt;2e-16 ***
s(Garage_Area)   7.426  8.328  21.654  &lt;2e-16 ***
s(Gr_Liv_Area)   8.546  8.882  14.834  &lt;2e-16 ***
s(TotRms_AbvGrd) 3.805  4.739   1.921  0.0783 .  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

R-sq.(adj) =  0.851   Deviance explained = 85.6%
-REML =  23957  Scale est. = 9.2391e+08  n = 2051</code></pre>
</div>
</div>
<p>There are some variables with high p-values that can be removed. The <code>gam</code> function has a <code>select</code> option which will penalize variable edf values.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>sel_gam2 <span class="ot">&lt;-</span> <span class="fu">gam</span>(</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    Sale_Price <span class="sc">~</span> <span class="fu">s</span>(Bedroom_AbvGr, <span class="at">k =</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">s</span>(Year_Built) <span class="sc">+</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">s</span>(Mo_Sold) <span class="sc">+</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">s</span>(Lot_Area) <span class="sc">+</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">s</span>(First_Flr_SF) <span class="sc">+</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">s</span>(Second_Flr_SF) <span class="sc">+</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">s</span>(Garage_Area) <span class="sc">+</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">s</span>(Gr_Liv_Area) <span class="sc">+</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">s</span>(TotRms_AbvGrd) <span class="sc">+</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>        Street <span class="sc">+</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>        Central_Air <span class="sc">+</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">factor</span>(Fireplaces) <span class="sc">+</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">factor</span>(Full_Bath) <span class="sc">+</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">factor</span>(Half_Bath),</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">"REML"</span>,</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">select =</span> <span class="cn">TRUE</span>,</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> training</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(sel_gam2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Family: gaussian 
Link function: identity 

Formula:
Sale_Price ~ s(Bedroom_AbvGr, k = 5) + s(Year_Built) + s(Mo_Sold) + 
    s(Lot_Area) + s(First_Flr_SF) + s(Second_Flr_SF) + s(Garage_Area) + 
    s(Gr_Liv_Area) + s(TotRms_AbvGrd) + Street + Central_Air + 
    factor(Fireplaces) + factor(Full_Bath) + factor(Half_Bath)

Parametric coefficients:
                    Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)           139417      19644   7.097 1.76e-12 ***
StreetPave             27516      12778   2.153   0.0314 *  
Central_AirY           17909       3172   5.645 1.89e-08 ***
factor(Fireplaces)1    13741       1671   8.223 3.55e-16 ***
factor(Fireplaces)2    26998       3170   8.517  &lt; 2e-16 ***
factor(Fireplaces)3    17180      10612   1.619   0.1056    
factor(Fireplaces)4   -77383      31523  -2.455   0.0142 *  
factor(Full_Bath)1     -8354      14483  -0.577   0.5642    
factor(Full_Bath)2    -13973      14759  -0.947   0.3439    
factor(Full_Bath)3     -1749      15710  -0.111   0.9114    
factor(Full_Bath)4    -31031      22964  -1.351   0.1768    
factor(Half_Bath)1      2376       2200   1.080   0.2802    
factor(Half_Bath)2    -38160       9166  -4.163 3.27e-05 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Approximate significance of smooth terms:
                      edf Ref.df      F  p-value    
s(Bedroom_AbvGr) 2.505713      4 15.697  &lt; 2e-16 ***
s(Year_Built)    6.400950      9 87.241  &lt; 2e-16 ***
s(Mo_Sold)       0.002762      9  0.000   0.4536    
s(Lot_Area)      7.242803      9 10.938  &lt; 2e-16 ***
s(First_Flr_SF)  8.471172      9 19.763  &lt; 2e-16 ***
s(Second_Flr_SF) 0.949500      9  2.072 8.44e-06 ***
s(Garage_Area)   6.782102      9 19.327  &lt; 2e-16 ***
s(Gr_Liv_Area)   8.736843      9 14.613  &lt; 2e-16 ***
s(TotRms_AbvGrd) 3.248559      9  0.988   0.0215 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

R-sq.(adj) =  0.849   Deviance explained = 85.3%
-REML =  24068  Scale est. = 9.4133e+08  n = 2051</code></pre>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">

</div>
</div>
</div>
</section>
<section id="summary" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Summary</h1>
<p>Advantages:</p>
<ul>
<li>Allows for non-linear relationships without trying out many transformations</li>
<li>Improved predictions</li>
<li>Still has some “interpretation”</li>
<li>Computationally fast</li>
</ul>
<p>Disadvantages:</p>
<ul>
<li>Can incorporate interactions but can take time</li>
<li>Not good for large numbers of variables</li>
<li>Multicollinearity is still a problem</li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>