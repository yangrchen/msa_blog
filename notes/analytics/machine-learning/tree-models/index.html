<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Yang Chen">
<meta name="dcterms.date" content="2023-11-06">

<title>Yang MSA - Tree-based Models</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../../">
<link href="../../../../favicon.ico" rel="icon">
<script src="../../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../../../index.html">
    <span class="navbar-title">Yang MSA</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../../notes/index.html" rel="" target="">
 <span class="menu-text">Notes</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../blog/index.html" rel="" target="">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/yangrchen" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Tree-based Models</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">analytics</div>
                <div class="quarto-category">machine learning</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Yang Chen </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">November 6, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#decision-tree-review" id="toc-decision-tree-review" class="nav-link active" data-scroll-target="#decision-tree-review"><span class="header-section-number">1</span> Decision Tree Review</a></li>
  <li><a href="#bagging" id="toc-bagging" class="nav-link" data-scroll-target="#bagging"><span class="header-section-number">2</span> Bagging</a>
  <ul class="collapse">
  <li><a href="#bootstrapping" id="toc-bootstrapping" class="nav-link" data-scroll-target="#bootstrapping"><span class="header-section-number">2.1</span> Bootstrapping</a></li>
  <li><a href="#bagging-process" id="toc-bagging-process" class="nav-link" data-scroll-target="#bagging-process"><span class="header-section-number">2.2</span> Bagging Process</a></li>
  <li><a href="#bagging-example-for-trees" id="toc-bagging-example-for-trees" class="nav-link" data-scroll-target="#bagging-example-for-trees"><span class="header-section-number">2.3</span> Bagging Example for Trees</a></li>
  <li><a href="#bagging-summary" id="toc-bagging-summary" class="nav-link" data-scroll-target="#bagging-summary"><span class="header-section-number">2.4</span> Bagging Summary</a></li>
  </ul></li>
  <li><a href="#random-forests" id="toc-random-forests" class="nav-link" data-scroll-target="#random-forests"><span class="header-section-number">3</span> Random Forests</a>
  <ul class="collapse">
  <li><a href="#parameters-to-tune" id="toc-parameters-to-tune" class="nav-link" data-scroll-target="#parameters-to-tune"><span class="header-section-number">3.1</span> Parameters to Tune</a></li>
  <li><a href="#implementing-random-forests" id="toc-implementing-random-forests" class="nav-link" data-scroll-target="#implementing-random-forests"><span class="header-section-number">3.2</span> Implementing Random Forests</a></li>
  <li><a href="#tuning-random-forests" id="toc-tuning-random-forests" class="nav-link" data-scroll-target="#tuning-random-forests"><span class="header-section-number">3.3</span> Tuning Random Forests</a></li>
  <li><a href="#variable-selection" id="toc-variable-selection" class="nav-link" data-scroll-target="#variable-selection"><span class="header-section-number">3.4</span> Variable Selection</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">3.5</span> Summary</a></li>
  </ul></li>
  <li><a href="#interpretability" id="toc-interpretability" class="nav-link" data-scroll-target="#interpretability"><span class="header-section-number">4</span> Interpretability</a></li>
  <li><a href="#boosting" id="toc-boosting" class="nav-link" data-scroll-target="#boosting"><span class="header-section-number">5</span> Boosting</a></li>
  <li><a href="#adaboost" id="toc-adaboost" class="nav-link" data-scroll-target="#adaboost"><span class="header-section-number">6</span> AdaBoost</a>
  <ul class="collapse">
  <li><a href="#classifier-weights" id="toc-classifier-weights" class="nav-link" data-scroll-target="#classifier-weights"><span class="header-section-number">6.1</span> Classifier Weights</a></li>
  </ul></li>
  <li><a href="#gradient-boosting" id="toc-gradient-boosting" class="nav-link" data-scroll-target="#gradient-boosting"><span class="header-section-number">7</span> Gradient Boosting</a>
  <ul class="collapse">
  <li><a href="#overfitting-protection" id="toc-overfitting-protection" class="nav-link" data-scroll-target="#overfitting-protection"><span class="header-section-number">7.1</span> Overfitting Protection</a></li>
  <li><a href="#gradient-boosted-trees" id="toc-gradient-boosted-trees" class="nav-link" data-scroll-target="#gradient-boosted-trees"><span class="header-section-number">7.2</span> Gradient Boosted Trees</a></li>
  </ul></li>
  <li><a href="#gradient-descent" id="toc-gradient-descent" class="nav-link" data-scroll-target="#gradient-descent"><span class="header-section-number">8</span> Gradient Descent</a>
  <ul class="collapse">
  <li><a href="#stochastic-gradient-descent" id="toc-stochastic-gradient-descent" class="nav-link" data-scroll-target="#stochastic-gradient-descent"><span class="header-section-number">8.1</span> Stochastic Gradient Descent</a></li>
  <li><a href="#training-a-gradient-boosted-machine" id="toc-training-a-gradient-boosted-machine" class="nav-link" data-scroll-target="#training-a-gradient-boosted-machine"><span class="header-section-number">8.2</span> Training a Gradient Boosted Machine</a></li>
  </ul></li>
  <li><a href="#xgboost-introduction" id="toc-xgboost-introduction" class="nav-link" data-scroll-target="#xgboost-introduction"><span class="header-section-number">9</span> XGBoost Introduction</a>
  <ul class="collapse">
  <li><a href="#variable-importance-in-xgboost" id="toc-variable-importance-in-xgboost" class="nav-link" data-scroll-target="#variable-importance-in-xgboost"><span class="header-section-number">9.1</span> Variable Importance in XGBoost</a></li>
  <li><a href="#variable-selection-1" id="toc-variable-selection-1" class="nav-link" data-scroll-target="#variable-selection-1"><span class="header-section-number">9.2</span> Variable Selection</a></li>
  </ul></li>
  <li><a href="#gradient-boosting-summary" id="toc-gradient-boosting-summary" class="nav-link" data-scroll-target="#gradient-boosting-summary"><span class="header-section-number">10</span> Gradient Boosting Summary</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># | include: false</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>training <span class="op">=</span> r.training</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>testing <span class="op">=</span> r.testing</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="decision-tree-review" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Decision Tree Review</h1>
<p>Decision trees are built by recursively splitting the data into successively purer subsets of data using measures of purity–Gini, entropy, misclassifcation error rate.</p>
<div id="fig-dt-review-splits" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/dt-review-splits.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;1: Selecting the Split</figcaption>
</figure>
</div>
</section>
<section id="bagging" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Bagging</h1>
<p><strong>Bagging</strong> refers to bootstrap aggregation. In order to understand bagging, we need to understanding bootstrapping.</p>
<section id="bootstrapping" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="bootstrapping"><span class="header-section-number">2.1</span> Bootstrapping</h2>
<p>Take random samples of data <em>with replacement</em> that are the same size as the original dataset. Some observations will not be sampled which are referred to as <strong>out-of-bag observations</strong>.</p>
<div id="fig-bootstrapping-example" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/bootstrapping-example.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;2: Bootstrapping for 10 Observations</figcaption>
</figure>
</div>
<p>The out-of-bag observations can be used as a validation set. However, there is no guarantee what the size of each validation set will be.</p>
<p>It’s been proven that a bootstrap sample will contain approximately 63% of observations on average. Sample size is the same as original as some observations are repeated.</p>
</section>
<section id="bagging-process" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="bagging-process"><span class="header-section-number">2.2</span> Bagging Process</h2>
<ol type="1">
<li>Take <span class="math inline">\(k\)</span> bootstrap samples of size <span class="math inline">\(n\)</span> from the training data.</li>
<li>For each of the <span class="math inline">\(k\)</span> samples, create a model using that sample as training data.</li>
<li>Ensemble the <span class="math inline">\(k\)</span> different models.</li>
</ol>
<p>Bagging aggregates the <span class="math inline">\(k\)</span> models for the full dataset and compares the ensembled values to the actual truth of the original dataset.</p>
<p>This process can be computationally expensive if we focused on building <span class="math inline">\(k\)</span> complex models. For trees, we will actually just stick to building simple decision tree models with only one split.</p>
</section>
<section id="bagging-example-for-trees" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="bagging-example-for-trees"><span class="header-section-number">2.3</span> Bagging Example for Trees</h2>
<ol type="1">
<li>Take 10 bootstrap samples.</li>
<li>Build a tree with only one split.</li>
<li>Aggregate these rules into a voting ensemble.</li>
<li>Test performance of the voting ensemble on the whole dataset.</li>
</ol>
<div id="fig-bagging-example" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/bagging-example.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;3: Bagging Example</figcaption>
</figure>
</div>
</section>
<section id="bagging-summary" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="bagging-summary"><span class="header-section-number">2.4</span> Bagging Summary</h2>
<ul>
<li>Improves generalization error on models with high variance</li>
<li>If base classifier is stable (not high variance), bagging can actually make it worse</li>
<li>Does not focus on any particular observations in the training data (unlike boosting)</li>
</ul>
</section>
</section>
<section id="random-forests" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Random Forests</h1>
<p><strong>Random forests</strong> are ensembles of decision trees–ensembles work best when they find <strong>different patterns in the data</strong>.</p>
<p>Random forests also create <strong>random subsets of variables for each split</strong> and <strong>unpruned decision trees</strong> in each ensemble. The idea is that we give different a variables a chance to be a main split on the data. Results from trees are then ensembled together.</p>
<p>For a regression problem, we are taking the averages of the average predictions made from each model. The number of leaf nodes don’t matter since we are averaging the <em>final predictions</em> from each model.</p>
<section id="parameters-to-tune" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="parameters-to-tune"><span class="header-section-number">3.1</span> Parameters to Tune</h2>
<ul>
<li>Number of trees</li>
<li>Number of variables for each split</li>
<li>Depth of tree (defaults to unpruned)</li>
</ul>
</section>
<section id="implementing-random-forests" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="implementing-random-forests"><span class="header-section-number">3.2</span> Implementing Random Forests</h2>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">Python</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(randomForest)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-2" data-target-annotation="1">1</dt>
<dd>
<span data-code-annotation="1" data-code-cell="annotated-cell-2" data-code-lines="3"><code>ntree</code> is the number of trees</span>
</dd>
<dt data-target-cell="annotated-cell-2" data-target-annotation="2">2</dt>
<dd>
<span data-code-annotation="2" data-code-cell="annotated-cell-2" data-code-lines="4"><code>importance</code> is a flag to allow for variable importance</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>randomForest 4.7-1.1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Type rfNews() to see new features/changes/bug fixes.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'randomForest'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:dplyr':

    combine</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:ggplot2':

    margin</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="annotated-cell-2"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-2-1"><a href="#annotated-cell-2-1" aria-hidden="true" tabindex="-1"></a>rf_ames <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(</span>
<span id="annotated-cell-2-2"><a href="#annotated-cell-2-2" aria-hidden="true" tabindex="-1"></a>    Sale_Price <span class="sc">~</span> ., <span class="at">data =</span> training_df, </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-2-3" class="code-annotation-target"><a href="#annotated-cell-2-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">ntree =</span> <span class="dv">500</span>,</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="2" onclick="event.preventDefault();">2</a><a class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-2-4" class="code-annotation-target"><a href="#annotated-cell-2-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">importance =</span> <span class="cn">TRUE</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(rf_ames, <span class="at">main =</span> <span class="st">"Number of Trees Compared to MSE"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/MSE-plot-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>To get variable importance we can use <code>varImpPlot</code>:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">varImpPlot</span>(rf_ames, <span class="at">sort =</span> <span class="cn">TRUE</span>, <span class="at">n.var =</span> <span class="dv">10</span>, <span class="at">main =</span> <span class="st">"Top 10 Variable Importance"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/var-importance-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<ul>
<li>The x-axis represents how much more MSE your model would gain if you left out this variable</li>
<li>To calculate the MSE increase, the variable is randomly permuted to “remove” relationship with target</li>
</ul>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestRegressor</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>train_dummy <span class="op">=</span> pd.get_dummies(training, columns<span class="op">=</span>[<span class="st">"Street"</span>, <span class="st">"Central_Air"</span>])</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> train_dummy[<span class="st">"Sale_Price"</span>]</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> train_dummy.loc[:, train_dummy.columns <span class="op">!=</span> <span class="st">"Sale_Price"</span>]</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>rf_ames <span class="op">=</span> RandomForestRegressor(n_estimators<span class="op">=</span><span class="dv">100</span>, random_state<span class="op">=</span><span class="dv">12345</span>, oob_score<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>rf_ames.fit(X_train, y_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<style>#sk-container-id-1 {color: black;}#sk-container-id-1 pre{padding: 0;}#sk-container-id-1 div.sk-toggleable {background-color: white;}#sk-container-id-1 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-container-id-1 label.sk-toggleable__label-arrow:before {content: "▸";float: left;margin-right: 0.25em;color: #696969;}#sk-container-id-1 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-container-id-1 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-container-id-1 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-container-id-1 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-container-id-1 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-container-id-1 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: "▾";}#sk-container-id-1 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-container-id-1 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-container-id-1 div.sk-estimator:hover {background-color: #d4ebff;}#sk-container-id-1 div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-container-id-1 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: 0;}#sk-container-id-1 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;position: relative;}#sk-container-id-1 div.sk-item {position: relative;z-index: 1;}#sk-container-id-1 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;position: relative;}#sk-container-id-1 div.sk-item::before, #sk-container-id-1 div.sk-parallel-item::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: -1;}#sk-container-id-1 div.sk-parallel-item {display: flex;flex-direction: column;z-index: 1;position: relative;background-color: white;}#sk-container-id-1 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-container-id-1 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-container-id-1 div.sk-parallel-item:only-child::after {width: 0;}#sk-container-id-1 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;}#sk-container-id-1 div.sk-label label {font-family: monospace;font-weight: bold;display: inline-block;line-height: 1.2em;}#sk-container-id-1 div.sk-label-container {text-align: center;}#sk-container-id-1 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-container-id-1 div.sk-text-repr-fallback {display: none;}</style><div id="sk-container-id-1" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>RandomForestRegressor(oob_score=True, random_state=12345)</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br>On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden=""><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-1" type="checkbox" checked=""><label for="sk-estimator-id-1" class="sk-toggleable__label sk-toggleable__label-arrow">RandomForestRegressor</label><div class="sk-toggleable__content"><pre>RandomForestRegressor(oob_score=True, random_state=12345)</pre></div></div></div></div></div>
</div>
</div>
<p>We can plot the average decrease in impurity in the nodes of the tree:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>forest_importances <span class="op">=</span> pd.Series(</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    rf_ames.feature_importances_, index<span class="op">=</span>rf_ames.feature_names_in_</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>forest_importances.plot.bar(ax<span class="op">=</span>ax)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Feature Importances"</span>)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Mean decrease in impurity"</span>)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>fig.tight_layout()</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/py-var-importance-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="tuning-random-forests" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="tuning-random-forests"><span class="header-section-number">3.3</span> Tuning Random Forests</h2>
<p>The number of variables considered for each split is called <code>mtry</code> in <code>caret</code>. By default, <code>mtry</code> is <span class="math inline">\(\sqrt{p}\)</span>, with <span class="math inline">\(p\)</span> being number of variables.</p>
<p>We use validation (out-of-bag samples) to tune along with number of trees. We are measuring the total amount of error across all the samples we did not take.</p>
<p>For each <code>mtry</code>, the same bootstrap samples are used to give each attempt a fair shot.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tuneRF</span>(<span class="at">x =</span> training_df[, <span class="sc">-</span><span class="dv">1</span>], <span class="at">y =</span> training_df[, <span class="dv">1</span>], <span class="at">plot =</span> <span class="cn">TRUE</span>, <span class="at">ntreeTry =</span> <span class="dv">500</span>, <span class="at">stepFactor =</span> <span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>mtry = 4  OOB error = 855384447 
Searching left ...
mtry = 8    OOB error = 890709806 
-0.04129764 0.05 
Searching right ...
mtry = 2    OOB error = 908679993 
-0.06230596 0.05 </code></pre>
</div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/tuning-rf-3.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  mtry  OOBError
2    2 908679993
4    4 855384447
8    8 890709806</code></pre>
</div>
</div>
</section>
<section id="variable-selection" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="variable-selection"><span class="header-section-number">3.4</span> Variable Selection</h2>
<p>Random forests use all the variables since they are averaged across all the trees used to build the model. Variable selection can be performed by a variety of methods.</p>
<ul>
<li>Many permutations of including / excluding variables</li>
<li>Compare variables to random variable (newer way)</li>
</ul>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>training_df <span class="ot">&lt;-</span> training_df <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">random =</span> <span class="fu">rnorm</span>(<span class="dv">2051</span>))</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>rf_ames <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(Sale_Price <span class="sc">~</span> ., <span class="at">data =</span> training_df, <span class="at">ntree =</span> <span class="dv">500</span>, <span class="at">mtry =</span> <span class="dv">4</span>, <span class="at">importance =</span> <span class="cn">TRUE</span>)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="fu">varImpPlot</span>(rf_ames, <span class="at">sort =</span> <span class="cn">TRUE</span>, <span class="at">n.var =</span> <span class="dv">15</span>, <span class="at">main =</span> <span class="st">"Look for Variables Below Random Variable"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/random-variable-selection-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The idea is that any variables that are below the completely random variable do not perform as well overall.</p>
</section>
<section id="summary" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="summary"><span class="header-section-number">3.5</span> Summary</h2>
<p>If you are building a random forest model for a client, you want to focus on the predictions, results, and <em>maybe</em> the variable importance. Beyond that, the interpretability may be too complex.</p>
<p><strong>Advantages:</strong></p>
<ul>
<li>Computationally fast</li>
<li>Trees trained simultaneously</li>
<li>Accurate classification model</li>
<li>Variable importance</li>
<li>Missing data is OK</li>
</ul>
<p><strong>Disadvantages:</strong></p>
<ul>
<li>No “interpretability” other than variable importance</li>
<li>Tuning parameters</li>
</ul>
</section>
</section>
<section id="interpretability" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Interpretability</h1>
<p>Most machine learning models are not interpretable in the classical sense. The relationships modeled are <strong>not linear</strong> so the interpretations are much more complicated than a typical regression.</p>
<p>Similar to GAMs however, we can get a general idea of overall pattern for a predictor variable compared to a target using <strong>partial dependence plots</strong>.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">partialPlot</span>(rf_ames, training_df, Year_Built)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/partial-dependence-1.png" class="img-fluid" width="672"></p>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">partialPlot</span>(rf_ames, training_df, Garage_Area)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/partial-dependence-2.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="boosting" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Boosting</h1>
<p><strong>Boosting</strong> is similar to bagging in that we are still taking bootstrapped samples from the dataset. However, unlike bagging, observations are <strong>not sampled randomly</strong>. Boosting assigns weight to each trianing observation and uses the weight as a sampling distribution. In particular, we assign higher weight to the observations that are <strong>harder to classify</strong>.</p>
<div id="fig-boosting-probability" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/boosting-probability.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;4: Probability of Selection Observation</figcaption>
</figure>
</div>
<p>Boosting is trying to learn from its mistakes by selecting the observations that it gets wrong more often. Bagging will build the ensemble model <strong>simultaneously</strong>, but since each model in boosting informs the next we have to build models <strong>sequentially</strong>.</p>
<p>For our previous tree sample our process is:</p>
<ol type="1">
<li>Build a tree with only one split</li>
<li>Start with equal weights for each observation</li>
<li>Update weights each round based on the classification error</li>
</ol>
<div id="fig-three-boosting-rounds" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/three-boosting-rounds.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;5: Three Boosting Rounds</figcaption>
</figure>
</div>
</section>
<section id="adaboost" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> AdaBoost</h1>
<p>Boosted ensembles weight the votes of each classifier by a function of their accuracy. If the classifier get the higher weighted observations wrong, it has a higher error rate.</p>
<p>Put simply, more accurate guesses are more important.</p>
<section id="classifier-weights" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="classifier-weights"><span class="header-section-number">6.1</span> Classifier Weights</h2>
<p>Observations are each weighted based on how well they were predicted in the previous round.</p>
<p>Let the weights for each round be denoted as <span class="math inline">\(\omega_i\)</span> and the predictions for round be <span class="math inline">\(\hat{y}_{1,i}, \hat{y}_{2,i}\)</span>.</p>
<p>The prediction for each observation is derived from a classification as follows:</p>
<p><span class="math display">\[
\hat{y}_i = \omega_1 \hat{y}_{1,i} + \omega_2 \hat{y}_{2,i} + \cdots
\]</span></p>
</section>
</section>
<section id="gradient-boosting" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Gradient Boosting</h1>
<p>Idea behind gradient boosting to use simple model to predict the target. With the next model, we are trying to predict the initial model’s error, <span class="math inline">\(\epsilon_1\)</span>. Let’s say the first variable predicted most of the signal, then by predicting each error we are giving the other variables a chance to predict the signal where the first variable went wrong.</p>
<p>The idea of sequential building on the errors is why we consider this <em>boosting</em>. However, it’s different from the previous idea of boosting where we were applying weight classifiers to observations.</p>
<p><span class="math display">\[
y = f_1(x) + f_2(x) + f_3(x) + \cdots + f_k(x) + \epsilon_k
\]</span></p>
<ul>
<li>Each function <span class="math inline">\(f_i(x)\)</span> is trying to predict the previous error <span class="math inline">\(\epsilon_{i-1}\)</span></li>
</ul>
<section id="overfitting-protection" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="overfitting-protection"><span class="header-section-number">7.1</span> Overfitting Protection</h2>
<p>Gradient boosting regularizes with tunable parameters to prevent overfitting:</p>
<ol type="1">
<li>Reduce weight of each of the error models for prediction.</li>
</ol>
<p><span class="math display">\[
y = f_1(x) + \eta f_2(x) + \eta f_3(x) + \cdots + \eta f_k(x) + \epsilon_k
\]</span></p>
<ul>
<li>Smaller values of <span class="math inline">\(\eta\)</span> lead to less overfitting</li>
</ul>
<ol start="2" type="1">
<li>Number of trees used in the prediction where larger number of trees increases overfitting</li>
<li>Other parameters introduced over the years…</li>
</ol>
</section>
<section id="gradient-boosted-trees" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="gradient-boosted-trees"><span class="header-section-number">7.2</span> Gradient Boosted Trees</h2>
<p>Gradient boosting yields an <strong>additive ensemble model</strong>. There is no averaging of individual models. Predictions from each model are summed together for final prediction.</p>
<p>The key to gradient boosting is using weak learners (shallow trees). Although each learner would make poor predictions on their own, their addition provides good predictions.</p>
<div id="fig-weak-learner-ensemble" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/weak-learner-ensemble.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;6: Weak Learner Ensemble</figcaption>
</figure>
</div>
</section>
</section>
<section id="gradient-descent" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> Gradient Descent</h1>
<p>Models are optimized to some form of <strong>loss function</strong>. For example, linear regression and decision trees typically look at minimizing SSE. The SSE represents the overall loss of the model. To find the model with the lowest loss function, we can use <strong>gradient descent</strong>.</p>
<p>Gradient descent iteratively updates parameters in order to minimize the loss function by moving int he direction of “steepest descent”.</p>
<div id="fig-gradient-descent" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/gradient-descent.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;7: Gradient Descent</figcaption>
</figure>
</div>
<p>Step size is updated at each step by multiplying the gradient by a <strong>learning rate</strong>. Without a learning rate, wem igth take steps too big or too small (too long to optimize).</p>
<section id="stochastic-gradient-descent" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="stochastic-gradient-descent"><span class="header-section-number">8.1</span> Stochastic Gradient Descent</h2>
<p>Not all loss functions are convex and some have local minima or plateaus that make finding the global minimum difficult.</p>
<p><strong>Stochastic gradient descent</strong> attempts to solve this by randomly sampling a fraction of the training observations for each tree in the ensemble. This makes the algorithm faster and more reliable, but may not always find the true overall minimum.</p>
</section>
<section id="training-a-gradient-boosted-machine" class="level2" data-number="8.2">
<h2 data-number="8.2" class="anchored" data-anchor-id="training-a-gradient-boosted-machine"><span class="header-section-number">8.2</span> Training a Gradient Boosted Machine</h2>
<p>Grid search is very time consuming because of the time it takes to build these models. We can tune parameters one at a time:</p>
<ol type="1">
<li>Start with relatively high learning rate (default of 0.1 is typically good).</li>
<li>Determine optimal number of trees for this learning rate.</li>
<li>Fix tree tuning parameters (number of trees, depth, etc.) and tune learning rate.</li>
<li>Set learning rate again at this new value and retune tree parameters.</li>
<li>Try lowering learning rate again to see any improvements.</li>
</ol>
</section>
</section>
<section id="xgboost-introduction" class="level1" data-number="9">
<h1 data-number="9"><span class="header-section-number">9</span> XGBoost Introduction</h1>
<p><strong>Extreme gradient boosting</strong> has different advantages over traditional GBM:</p>
<ol type="1">
<li>Additional regularization parameters to prevent overfitting.</li>
<li>Settings to stop model assessment when adding more trees isn’t helpful.</li>
<li>Supports parallel processing, but still must be trained sequentially.</li>
<li>Variety of loss functions.</li>
<li>Allows generalized linear models as well as tree-based models (all still weak learners).</li>
<li>Implemented in R, Python, Julia, Scala, Java, C++, etc.</li>
</ol>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false">Python</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># library(xgboost)</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co"># train_x &lt;- model.matrix(Sale_Price ~ ., data = training)[, -1]</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co"># train_y &lt;- training$Sale_Price</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co"># set.seed(12345)</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co"># xgb_ames &lt;- xgboost(data = train_x, label = train_y, subsample = 0.5, nrounds = 100)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> xgboost <span class="im">import</span> XGBRegressor</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>xgb_ames <span class="op">=</span> XGBRegressor(n_estimators<span class="op">=</span><span class="dv">50</span>, subsample<span class="op">=</span><span class="fl">0.5</span>, random_state<span class="op">=</span><span class="dv">12345</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>xgb_ames.fit(X_train, y_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<style>#sk-container-id-2 {color: black;}#sk-container-id-2 pre{padding: 0;}#sk-container-id-2 div.sk-toggleable {background-color: white;}#sk-container-id-2 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-container-id-2 label.sk-toggleable__label-arrow:before {content: "▸";float: left;margin-right: 0.25em;color: #696969;}#sk-container-id-2 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-container-id-2 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-container-id-2 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-container-id-2 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-container-id-2 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-container-id-2 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: "▾";}#sk-container-id-2 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-2 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-2 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-container-id-2 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-container-id-2 div.sk-estimator:hover {background-color: #d4ebff;}#sk-container-id-2 div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-container-id-2 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-2 div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: 0;}#sk-container-id-2 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;position: relative;}#sk-container-id-2 div.sk-item {position: relative;z-index: 1;}#sk-container-id-2 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;position: relative;}#sk-container-id-2 div.sk-item::before, #sk-container-id-2 div.sk-parallel-item::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: -1;}#sk-container-id-2 div.sk-parallel-item {display: flex;flex-direction: column;z-index: 1;position: relative;background-color: white;}#sk-container-id-2 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-container-id-2 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-container-id-2 div.sk-parallel-item:only-child::after {width: 0;}#sk-container-id-2 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;}#sk-container-id-2 div.sk-label label {font-family: monospace;font-weight: bold;display: inline-block;line-height: 1.2em;}#sk-container-id-2 div.sk-label-container {text-align: center;}#sk-container-id-2 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-container-id-2 div.sk-text-repr-fallback {display: none;}</style><div id="sk-container-id-2" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>XGBRegressor(base_score=None, booster=None, callbacks=None,
             colsample_bylevel=None, colsample_bynode=None,
             colsample_bytree=None, early_stopping_rounds=None,
             enable_categorical=False, eval_metric=None, feature_types=None,
             gamma=None, gpu_id=None, grow_policy=None, importance_type=None,
             interaction_constraints=None, learning_rate=None, max_bin=None,
             max_cat_threshold=None, max_cat_to_onehot=None,
             max_delta_step=None, max_depth=None, max_leaves=None,
             min_child_weight=None, missing=nan, monotone_constraints=None,
             n_estimators=50, n_jobs=None, num_parallel_tree=None,
             predictor=None, random_state=12345, ...)</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br>On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden=""><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-2" type="checkbox" checked=""><label for="sk-estimator-id-2" class="sk-toggleable__label sk-toggleable__label-arrow">XGBRegressor</label><div class="sk-toggleable__content"><pre>XGBRegressor(base_score=None, booster=None, callbacks=None,
             colsample_bylevel=None, colsample_bynode=None,
             colsample_bytree=None, early_stopping_rounds=None,
             enable_categorical=False, eval_metric=None, feature_types=None,
             gamma=None, gpu_id=None, grow_policy=None, importance_type=None,
             interaction_constraints=None, learning_rate=None, max_bin=None,
             max_cat_threshold=None, max_cat_to_onehot=None,
             max_delta_step=None, max_depth=None, max_leaves=None,
             min_child_weight=None, missing=nan, monotone_constraints=None,
             n_estimators=50, n_jobs=None, num_parallel_tree=None,
             predictor=None, random_state=12345, ...)</pre></div></div></div></div></div>
</div>
</div>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="annotated-cell-2"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-2-1"><a href="#annotated-cell-2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> GridSearchCV</span>
<span id="annotated-cell-2-2"><a href="#annotated-cell-2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-2-3"><a href="#annotated-cell-2-3" aria-hidden="true" tabindex="-1"></a>param_grid <span class="op">=</span> {</span>
<span id="annotated-cell-2-4"><a href="#annotated-cell-2-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"n_estimators"</span>: <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">5</span>, <span class="dv">51</span>, <span class="dv">5</span>)),</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-2-5" class="code-annotation-target"><a href="#annotated-cell-2-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"eta"</span>: [<span class="fl">0.1</span>, <span class="fl">0.15</span>, <span class="fl">0.2</span>, <span class="fl">0.25</span>, <span class="fl">0.3</span>],</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-2-6" class="code-annotation-target"><a href="#annotated-cell-2-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"max_depth"</span>: <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">11</span>)),</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-2-7" class="code-annotation-target"><a href="#annotated-cell-2-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"subsample"</span>: [<span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="dv">1</span>]</span>
<span id="annotated-cell-2-8"><a href="#annotated-cell-2-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="annotated-cell-2-9"><a href="#annotated-cell-2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-2-10"><a href="#annotated-cell-2-10" aria-hidden="true" tabindex="-1"></a>xgb <span class="op">=</span> XGBRegressor()</span>
<span id="annotated-cell-2-11"><a href="#annotated-cell-2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-2-12"><a href="#annotated-cell-2-12" aria-hidden="true" tabindex="-1"></a>grid_search <span class="op">=</span> GridSearchCV(estimator<span class="op">=</span>xgb, param_grid<span class="op">=</span>param_grid, cv <span class="op">=</span> <span class="dv">10</span>)</span>
<span id="annotated-cell-2-13"><a href="#annotated-cell-2-13" aria-hidden="true" tabindex="-1"></a><span class="co"># grid_search.fit(X_train, y_train)</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-annotation">
<dl>
<dt data-target-cell="annotated-cell-2" data-target-annotation="1">1</dt>
<dd>
<span data-code-annotation="1" data-code-cell="annotated-cell-2" data-code-lines="4"><code>n_estimators</code> is the number of trees we will use</span>
</dd>
<dt data-target-cell="annotated-cell-2" data-target-annotation="2">2</dt>
<dd>
<span data-code-annotation="2" data-code-cell="annotated-cell-2" data-code-lines="5"><code>eta</code> is the regularization parameter</span>
</dd>
<dt data-target-cell="annotated-cell-2" data-target-annotation="3">3</dt>
<dd>
<span data-code-annotation="3" data-code-cell="annotated-cell-2" data-code-lines="6"><code>max_depth</code> is the maximum depth of our trees</span>
</dd>
<dt data-target-cell="annotated-cell-2" data-target-annotation="4">4</dt>
<dd>
<span data-code-annotation="4" data-code-cell="annotated-cell-2" data-code-lines="7"><code>subsample</code> is the fraction of our data that we use in stochastic gradient descent</span>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
<section id="variable-importance-in-xgboost" class="level2" data-number="9.1">
<h2 data-number="9.1" class="anchored" data-anchor-id="variable-importance-in-xgboost"><span class="header-section-number">9.1</span> Variable Importance in XGBoost</h2>
<p>XGBoost provides 3 built-in measures of variable importance:</p>
<ol type="1">
<li><strong>Gain</strong>: Equivalent metric in random forests</li>
<li><strong>Coverage</strong>: Measures relative number of observations influenced by the variable</li>
<li><strong>Frequency</strong>: Percentage of splits in the whole ensemble that use this variable</li>
</ol>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set.seed(12345)</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co"># xgb_ames &lt;- xgboost(data = train_x, label = train_y, subsample = 1, nrounds = 24, eta = 0.25, max_depth = 5)</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co"># xgb.importance(features_names = colnames(train_x), model = xgb_ames)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># xgb.ggplot.importance(xgb.importance(feature_names = colnames(train_x), model = xgb_ames))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>One of the advantages of XGBoost is that it tries to cluster variables in terms of their importance. There is some notion of statistically different importances between variables.</p>
</section>
<section id="variable-selection-1" class="level2" data-number="9.2">
<h2 data-number="9.2" class="anchored" data-anchor-id="variable-selection-1"><span class="header-section-number">9.2</span> Variable Selection</h2>
<p>XGBoost uses all variables since they are averages across all the trees used to build the model.</p>
<p>Variable selection can be performed by permutations of including and excluding variables. However, this is extremely time confusing.</p>
<p>Similarly to the random forest models, we can compare variables to a random variable and potentially exclude variables that end up less important than the random variable.</p>
</section>
</section>
<section id="gradient-boosting-summary" class="level1" data-number="10">
<h1 data-number="10"><span class="header-section-number">10</span> Gradient Boosting Summary</h1>
<p><strong>Advantages:</strong></p>
<ul>
<li>Very accurate</li>
<li>Tend to outperform random forests when properly trained and tuned</li>
<li>Variable importance provided</li>
</ul>
<p><strong>Disadvantages:</strong></p>
<ul>
<li>Lacks “interpretability” beyond variable importance</li>
<li>Computationally slower than random forests</li>
<li>More tuning parameters than random forest</li>
<li>Harder to optimize</li>
<li>More sensitive to tuning parameters</li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>